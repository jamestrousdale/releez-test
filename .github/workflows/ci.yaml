name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened]
  push:
    branches:
      - main

permissions:
  contents: read

jobs:
  version-artifact:
    name: Detect release version
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          fetch-tags: true

      - name: Set prerelease params
        id: params
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "prerelease-type=beta" >> "$GITHUB_OUTPUT"
            echo "prerelease-number=${{ github.event.pull_request.number }}" >> "$GITHUB_OUTPUT"
          else
            echo "prerelease-type=rc" >> "$GITHUB_OUTPUT"
            echo "prerelease-number=0" >> "$GITHUB_OUTPUT"
          fi

      - name: Detect version artifact
        id: releez
        uses: hotdog-werx/releez@feature/monorepo-support
        with:
          mode: version-artifact
          is-full-release: 'false'
          prerelease-type: ${{ steps.params.outputs.prerelease-type }}
          prerelease-number: ${{ steps.params.outputs.prerelease-number }}
          build-number: ${{ github.run_number }}

      - name: Print outputs
        env:
          SEMVER_VERSIONS: ${{ steps.releez.outputs.semver-versions }}
          DOCKER_VERSIONS: ${{ steps.releez.outputs.docker-versions }}
          PEP440_VERSIONS: ${{ steps.releez.outputs.pep440-versions }}
        run: |
          RELEASE_VERSION="${{ steps.releez.outputs.release-version }}"
          PROJECT="${{ steps.releez.outputs.project }}"

          echo "release-version: $RELEASE_VERSION"
          echo "project:         $PROJECT"
          echo ""
          echo "semver-versions:"
          echo "$SEMVER_VERSIONS" | sed 's/^/  /'
          echo "docker-versions:"
          echo "$DOCKER_VERSIONS" | sed 's/^/  /'
          echo "pep440-versions:"
          echo "$PEP440_VERSIONS" | sed 's/^/  /'

          SEMVER_EXACT=$(echo "$SEMVER_VERSIONS" | head -1)
          DOCKER_EXACT=$(echo "$DOCKER_VERSIONS" | head -1)
          PEP440_EXACT=$(echo "$PEP440_VERSIONS" | head -1)

          PROJECT_LABEL="${PROJECT:+$PROJECT }${RELEASE_VERSION}"
          echo "::notice title=Release version::${PROJECT_LABEL}"
          echo "::notice title=semver::${SEMVER_EXACT}"
          echo "::notice title=docker::${DOCKER_EXACT}"
          echo "::notice title=pep440::${PEP440_EXACT}"
